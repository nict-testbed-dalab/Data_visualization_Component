
## ◆ 立体グラフ表示機能の処理詳細

立体グラフ表示機能の処理詳細を以下に示す。

__Mapbox__

MapboxではTurf.jsとMapboxのfill-extrusionレイヤーを利用して描画する。詳細を以下に記述する。

  1. インプットデータとして、CSVファイルをD3.js利用で読み取る。
  2. Turf.jsのポリゴン作成機能(turf.circle)とMapboxのLayerを利用して立体グラフ用のLayerを作成する。
  3. 立体グラフ用のLayerを地図へ追加する。

更に時系列データ表示、UI操作による立体グラフの描画変更のために、以下の処理を行う。

  0. 時系列データとして、対応する時刻をYYYYMMDDhhmmの形式にした名前のファイルを準備する
  1. WebGISアプリの表示時刻に合わせて、ファイルを選択し、Sourceデータを作成する。
  2. 描画済みのLayerのsourceを新たに作成したsourceへ置き換える。ファイルがなければLayerを非表示にする。

__iTowns__

iTownsでは、立体グラフ表示ライブラリ 3dBargraph.js を作成し、それを利用して立体グラフを表示する。詳細は以下に記述する。  
この実装は https://github.com/SIPupstreamDesign/ChOWDER/ の実装を流用して作成している。  
立体グラフ用のクラスとして itowns.GeometryLayer を継承した BarGraphLayer を実装している。  

  * BarGraphLayerのコンストラクタで実施
  1. itowns.FileSource を利用してCSVファイルを読み取り、コード内に実装したカラムでデータをパースする
  2. 立体グラフを描画するための立方体モデルを作成する。
  * BarGraphLayer#updateBarGraphで実施
  3. データをもとに、各地点に立方体モデルを配置、指定された立体グラフの色、高さ、太さに合わせてモデルを変形する。

更に時系列データ表示、UI操作による立体グラフの描画変更のために、以下の処理を行う。  

  0. 時系列データとして、対応する時刻をYYYYMMDDhhmmの形式にした名前のファイルを準備する
  1. 表示済の立体グラフ用のLayerを削除する。
  2. WebGISアプリの表示時刻に合わせてCSVファイルを選択し、Layerを作成、追加する。


## ◆ データ形式

__Mapbox__

CSV形式、以下のカラムをヘッダ付きで作成する。

| カラム | 値 |
| :--- |:---------|
| name | 地点の名称<br>(サンプルアプリでは使用していない) |
| lng  | 地点の経度 |
| lat  | 地点の緯度 |
| value | 地点に関するデータ |


__iTowns__

CSV形式、以下のカラムをヘッダ付きで作成する。

| カラム | 値 |
| :--- |:---------|
| name | 地点の名称<br>(サンプルアプリでは使用していない) |
| lng  | 地点の経度 |
| lat  | 地点の緯度 |
| value | 地点に関するデータ |

